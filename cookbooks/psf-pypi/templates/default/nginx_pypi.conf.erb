# Generated by Chef
# Local modifications will be overwritten

server {
  listen 80<% if @default_server %> default_server<% end %>;
  server_name <%= @domains.first %>;
  root <%= @root_dir %>;

  <% if @hsts_seconds %>
  add_header Strict-Transport-Security "max-age=<%= @hsts_seconds %>";
  <% end %>

  rewrite ^/$ https://<%= @domains.first %>/pypi redirect;

  location ~* ^/(pypi|daytime|mirrors|id|oauth|security).* {
    include uwsgi_params;
    uwsgi_pass <%= @uwsgi_sock %>;
    uwsgi_param SCRIPT_NAME /$1;
    # the following magic stands for "UWSGI_MODIFIER_MANAGE_PATH_INFO"
    # .. when setting the SCRIPT_NAME remove that bit from the PATH_INFO
    uwsgi_modifier1 30;
  }

  location ~* ^/(simple|serversig|packages).* {
    include uwsgi_params;
    uwsgi_pass <%= @uwsgi_sock %>;
    uwsgi_param SCRIPT_NAME /$1;
    # the following magic stands for "UWSGI_MODIFIER_MANAGE_PATH_INFO"
    # .. when setting the SCRIPT_NAME remove that bit from the PATH_INFO
    uwsgi_modifier1 30;

    gzip on;
    gzip_comp_level 9;
    gzip_vary on;
  }

  location /raw-packages {
    alias <%= @packages_dir %>;

    add_header X-PYPI-LAST-SERIAL $upstream_http_x_pypi_last_serial;
    add_header Surrogate-Key $upstream_http_surrogate_key;

    internal;

    autoindex on;

    <% if @hsts_seconds %>
    add_header Strict-Transport-Security "max-age=<%= @hsts_seconds %>";
    <% end %>
  }

  location ~* ^/(stats|local-stats).* {
    autoindex on;
  }

  location /static {
    alias <%= @static_dir %>;

    add_header Cache-Control public;
    expires    1d;

    <% if @hsts_seconds %>
    add_header Strict-Transport-Security "max-age=<%= @hsts_seconds %>";
    <% end %>
  }

  # allow big uploads
  client_max_body_size <%= @upload_size %>;
}

<% if @domains.length > 1 %>
server {
  listen 80;
  server_name <%= @domains.last(@domains.length - 1).join(" ") %>;
  rewrite ^ $scheme://<%= @domains.first %>$request_uri permanent;
}
<% end %>
